<!DOCTYPE html><html><head><meta charset="utf-8"></meta><meta content="width=device-width, initial-scale=1" name="viewport"></meta><title>class SelectionDAGBuilder::StackProtectorDescriptor: LLVM 10.0.0 documentation</title><link href="styles.css" rel="stylesheet"></link><script src="highlight.min.js"></script><script>hljs.highlightAll();</script><link href="katex.min.css" rel="stylesheet"></link><script src="katex.min.js"></script><script src="auto-render.min.js"></script><script>
    document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
        ],
      });
    });
  </script><link href="apple-touch-icon.png" sizes="180x180" rel="apple-touch-icon"></link><link href="favicon-32x32.png" sizes="32x32" type="image/png" rel="icon"></link><link href="favicon-16x16.png" sizes="16x16" type="image/png" rel="icon"></link></head><body><div id="wrapper"><section class="section"><div class="container"><div class="columns"><aside class="column is-one-fifth"><ul class="menu-list"><p class="is-size-4">LLVM 10.0.0</p><p class="menu-label">Navigation</p><li><a href="index.html">Home</a></li><li><a href="search.html">Search</a></li><li><a href="https://github.com/llvm/llvm-project/">Repository</a></li><li><a href="https://hdoc.io">Made with hdoc</a></li><p class="menu-label">API Documentation</p><li><a href="functions.html">Functions</a></li><li><a href="records.html">Records</a></li><li><a href="enums.html">Enums</a></li><li><a href="namespaces.html">Namespaces</a></li></ul></aside><div class="column" style="overflow-x: auto"><nav class="breadcrumb has-arrow-separator" aria-label="breadcrumbs"><ul><li><a href="namespaces.html#00A4DA910CC17C2D"><span>namespace llvm</span></a></li><li><a href="rD2316E3D008BBF65.html"><span>class SelectionDAGBuilder</span></a></li><li class="is-active"><a aria-current="pageAE67AD9012C09150"><span>class SelectionDAGBuilder::StackProtectorDescriptor</span></a></li></ul></nav><main class="content"><h1>class SelectionDAGBuilder::StackProtectorDescriptor</h1><h2>Declaration</h2><pre class="p-0"><code class="hdoc-record-code language-cpp">class SelectionDAGBuilder::StackProtectorDescriptor { /* full declaration omitted */ };</code></pre><h2>Description</h2><p>A class which encapsulates all of the information needed to generate a stack protector check and signals to isel via its state being initialized that a stack protector needs to be generated. *NOTE* The following is a high level documentation of SelectionDAG Stack Protector Generation. The reason that it is placed here is for a lack of other good places to stick it. High Level Overview of SelectionDAG Stack Protector Generation: Previously, generation of stack protectors was done exclusively in the pre-SelectionDAG Codegen LLVM IR Pass &quot;Stack Protector&quot;. This necessitated splitting basic blocks at the IR level to create the success/failure basic blocks in the tail of the basic block in question. As a result of this, calls that would have qualified for the sibling call optimization were no longer eligible for optimization since said calls were no longer right in the &quot;tail position&quot; (i.e. the immediate predecessor of a ReturnInst instruction). Then it was noticed that since the sibling call optimization causes the callee to reuse the caller&apos;s stack, if we could delay the generation of the stack protector check until later in CodeGen after the sibling call decision was made, we get both the tail call optimization and the stack protector check! A few goals in solving this problem were: 1. Preserve the architecture independence of stack protector generation. 2. Preserve the normal IR level stack protector check for platforms like OpenBSD for which we support platform-specific stack protector generation. The main problem that guided the present solution is that one can not solve this problem in an architecture independent manner at the IR level only. This is because: 1. The decision on whether or not to perform a sibling call on certain platforms (for instance i386) requires lower level information related to available registers that can not be known at the IR level. 2. Even if the previous point were not true, the decision on whether to perform a tail call is done in LowerCallTo in SelectionDAG which occurs after the Stack Protector Pass. As a result, one would need to put the relevant callinst into the stack protector check success basic block (where the return inst is placed) and then move it back later at SelectionDAG/MI time before the stack protector check if the tail call optimization failed. The MI level option was nixed immediately since it would require platform-specific pattern matching. The SelectionDAG level option was nixed because SelectionDAG only processes one IR level basic block at a time implying one could not create a DAG Combine to move the callinst. To get around this problem a few things were realized: 1. While one can not handle multiple IR level basic blocks at the SelectionDAG Level, one can generate multiple machine basic blocks for one IR level basic block. This is how we handle bit tests and switches. 2. At the MI level, tail calls are represented via a special return MIInst called &quot;tcreturn&quot;. Thus if we know the basic block in which we wish to insert the stack protector check, we get the correct behavior by always inserting the stack protector check right before the return statement. This is a &quot;magical transformation&quot; since no matter where the stack protector check intrinsic is, we always insert the stack protector check code at the end of the BB. Given the aforementioned constraints, the following solution was devised: 1. On platforms that do not support SelectionDAG stack protector check generation, allow for the normal IR level stack protector check generation to continue. 2. On platforms that do support SelectionDAG stack protector check generation: a. Use the IR level stack protector pass to decide if a stack protector is required/which BB we insert the stack protector check in by reusing the logic already therein. If we wish to generate a stack protector check in a basic block, we place a special IR intrinsic called llvm.stackprotectorcheck right before the BB&apos;s returninst or if there is a callinst that could potentially be sibling call optimized, before the call inst. b. Then when a BB with said intrinsic is processed, we codegen the BB normally via SelectBasicBlock. In said process, when we visit the stack protector check, we do not actually emit anything into the BB. Instead, we just initialize the stack protector descriptor class (which involves stashing information/creating the success mbbb and the failure mbb if we have not created one for this function yet) and export the guard variable that we are going to compare. c. After we finish selecting the basic block, in FinishBasicBlock if the StackProtectorDescriptor attached to the SelectionDAGBuilder is initialized, we produce the validation code with one of these techniques: 1) with a call to a guard check function 2) with inlined instrumentation 1) We insert a call to the check function before the terminator. 2) We first find a splice point in the parent basic block before the terminator and then splice the terminator of said basic block into the success basic block. Then we code-gen a new tail for the parent basic block consisting of the two loads, the comparison, and finally two branches to the success/failure basic blocks. We conclude by code-gening the failure basic block if we have not code-gened it already (all stack protector checks we generate in the same function, use the same failure basic block).</p><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L297">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:297</a></p><h2>Method Overview</h2><ul><li class="is-family-code">public  <a href="#1C65DFFBE827A1C3"><b>StackProtectorDescriptor</b></a>()</li><li class="is-family-code">public llvm::MachineBasicBlock *  <a href="#95E45566F8978421"><b>getFailureMBB</b></a>()</li><li class="is-family-code">public llvm::MachineBasicBlock *  <a href="#BF243C7E47A9ACFB"><b>getParentMBB</b></a>()</li><li class="is-family-code">public llvm::MachineBasicBlock *  <a href="#90569798A470C16B"><b>getSuccessMBB</b></a>()</li><li class="is-family-code">public void  <a href="#558228B07EB8FAC7"><b>initialize</b></a>(const llvm::BasicBlock * BB, llvm::MachineBasicBlock * MBB, bool FunctionBasedInstrumentation)</li><li class="is-family-code">public void  <a href="#39904B2450F26D58"><b>resetPerBBState</b></a>()</li><li class="is-family-code">public void  <a href="#84ED4C260DD891DE"><b>resetPerFunctionState</b></a>()</li><li class="is-family-code">public bool  <a href="#4AFE6388C46560FA"><b>shouldEmitFunctionBasedCheckStackProtector</b></a>() const</li><li class="is-family-code">public bool  <a href="#28E4500960694FFB"><b>shouldEmitStackProtector</b></a>() const</li></ul><h2>Methods</h2><h3 id="1C65DFFBE827A1C3"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#1C65DFFBE827A1C3">¶</a><code class="hdoc-function-code language-cpp">StackProtectorDescriptor()</code></pre></h3><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L299">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:299</a></p><h3 id="95E45566F8978421"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#95E45566F8978421">¶</a><code class="hdoc-function-code language-cpp"><a href="rD94B5FBC5E7E6A08.html">llvm::MachineBasicBlock</a>* getFailureMBB()</code></pre></h3><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L355">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:355</a></p><h3 id="BF243C7E47A9ACFB"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#BF243C7E47A9ACFB">¶</a><code class="hdoc-function-code language-cpp"><a href="rD94B5FBC5E7E6A08.html">llvm::MachineBasicBlock</a>* getParentMBB()</code></pre></h3><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L353">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:353</a></p><h3 id="90569798A470C16B"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#90569798A470C16B">¶</a><code class="hdoc-function-code language-cpp"><a href="rD94B5FBC5E7E6A08.html">llvm::MachineBasicBlock</a>* getSuccessMBB()</code></pre></h3><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L354">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:354</a></p><h3 id="558228B07EB8FAC7"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#558228B07EB8FAC7">¶</a><code class="hdoc-function-code language-cpp">void initialize(const <a href="r5F23A6FBCC3A87BD.html">llvm::BasicBlock</a>* BB,
                <a href="rD94B5FBC5E7E6A08.html">llvm::MachineBasicBlock</a>* MBB,
                bool FunctionBasedInstrumentation)</code></pre></h3><h4>Description</h4><p>Initialize the stack protector descriptor structure for a new basic block.</p><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L313">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:313</a></p><h4>Parameters</h4><dl><dt class="is-family-code">const <a href="r5F23A6FBCC3A87BD.html">llvm::BasicBlock</a>*<b> BB</b></dt><dt class="is-family-code"><a href="rD94B5FBC5E7E6A08.html">llvm::MachineBasicBlock</a>*<b> MBB</b></dt><dt class="is-family-code">bool<b> FunctionBasedInstrumentation</b></dt></dl><h3 id="39904B2450F26D58"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#39904B2450F26D58">¶</a><code class="hdoc-function-code language-cpp">void resetPerBBState()</code></pre></h3><h4>Description</h4><p>Reset state that changes when we handle different basic blocks. This currently includes: 1. The specific basic block we are generating a stack protector for (ParentMBB). 2. The successor machine basic block that will contain the tail of parent mbb after we create the stack protector check (SuccessMBB). This BB is visited only on stack protector check success.</p><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L335">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:335</a></p><h3 id="84ED4C260DD891DE"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#84ED4C260DD891DE">¶</a><code class="hdoc-function-code language-cpp">void resetPerFunctionState()</code></pre></h3><h4>Description</h4><p>Reset state that only changes when we switch functions. This currently includes: 1. FailureMBB since we reuse the failure code path for all stack protector checks created in an individual function. 2.The guard variable since the guard variable we are checking against is always the same.</p><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L349">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:349</a></p><h3 id="4AFE6388C46560FA"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#4AFE6388C46560FA">¶</a><code class="hdoc-function-code language-cpp">bool shouldEmitFunctionBasedCheckStackProtector()
    const</code></pre></h3><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L307">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:307</a></p><h3 id="28E4500960694FFB"><pre class="p-0 hdoc-pre-parent"><a class="hdoc-permalink-icon" href="#28E4500960694FFB">¶</a><code class="hdoc-function-code language-cpp">bool shouldEmitStackProtector() const</code></pre></h3><h4>Description</h4><p>Returns true if all fields of the stack protector descriptor are initialized implying that we should/are ready to emit a stack protector.</p><p>Declared at: <a class="is-family-code" href="https://github.com/llvm/llvm-project/blob/release/10.x/llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h#L303">llvm/lib/CodeGen/SelectionDAG/SelectionDAGBuilder.h:303</a></p></main></div></div></div></section></div><footer class="footer"><p>Documentation for LLVM 10.0.0.</p><p>Generated by <a href="https://hdoc.io/">hdoc</a> version 1.4.0-hdocInternal on 2022-12-14T09:44:14 UTC.</p><p class="has-text-grey-light">19AD43E11B2996</p></footer></body></html>